import nextflow.util.SysHelper

// Default inputs/parameters of the pipeline
params {
    max_cpus   = SysHelper.getAvailCpus()
    max_memory = SysHelper.getAvailMemory()
    min_cpus = 1
    min_memory = 1.MB

    ucla_cds = true
    docker_container_registry = "ghcr.io/uclahs-cds"
}

// Process specific scope
process {
    // Process results are stored to local cache.
    // If pipeline is launched with the 'resume' option, existing cache results will be used when available
    // rather than re-executing processes
    cache = true

    // Forward process 'stdout' to shell terminal and, consequently, the log file
    echo = true
    executor = 'local'

    // Other directives or options that should apply for every process

    // total amount of resources avaible to the pipeline
    cpus = params.max_cpus
    memory = params.max_memory
}

profiles {
    standard {
        apptainer {
            enabled = false
        }

        docker {
            enabled = true
            uid_and_gid = "-u \$(id -u):\$(id -g)"
            all_group_ids = "\$(for i in `id --real --groups`; do echo -n \"--group-add=\$i \"; done)"
            runOptions = "${uid_and_gid} ${all_group_ids}"
        }

        params.container_mount_flag = "-v"
    }

    // Define copy of default standard profile as docker to allow explicit docker selection
    // Profile aliasing isn't directly available so profile is copied
    docker {
        apptainer {
            enabled = false
        }

        docker {
            enabled = true
            uid_and_gid = "-u \$(id -u):\$(id -g)"
            all_group_ids = "\$(for i in `id --real --groups`; do echo -n \"--group-add=\$i \"; done)"
            runOptions = "${uid_and_gid} ${all_group_ids}"
        }

        params.container_mount_flag = "-v"
    }

    apptainer {
        docker {
            enabled = false
        }

        apptainer {
            enabled = true

            autoMounts = true
            ociAutoPull = true
        }

        params.container_mount_flag = "-B"
    }
}
